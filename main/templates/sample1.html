<!DOCTYPE html>
{% load static %}
<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <style>
            .form-control {
                border: none;
            }
            .form-option .btn {
                border-radius: 0%;
                border: none;
            }
            .navbar-collapse {
                flex-basis: 0%;
            }
            .inputform {
                display: block;
            }
            .sublink_div {
                display: none;
            }
            #pendingtasks {
                display: none;
            }
        </style>
        <script>

            //To submit after checking task
            function checkerbox(event){
                const targform = event.target.parentElement; 
                targform[2].click();
            }

            function showcompletetask(name, taskid){
                const comd = document.createElement('div');
                comd.className = `row taskrow-${taskid}`;
                comd.innerHTML = `<div class="col"><a class="nav-link active" href="#" role="button"><h6 style="text-decoration: line-through;">${name}</h6></a></div><div class="col" style="max-width: max-content; padding:0%;"><form id="deletemain${taskid}" class="maintaskdelform"><input type="number" value="${taskid}" name="tasktodel" hidden><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/trash-2.svg' %}" style="width:20px; height:20px;"></button></div>`;
                document.getElementById("completedtaskdiv").append(comd);
            }

            //display already existing tasks
            function disp(data){
                if(data.tasks.complete === true){
                    showcompletetask(data.tasks.task_h,data.tasks.id);
                }else {
                    const newd = document.createElement('div');
                    newd.className = `row homedivs taskrow-${data.tasks.id}`;
                    newd.innerHTML = `<div class="col check-comp" style="padding: 0px ; max-width:50px;"><form id="status${data.tasks.id}" class="completestatusform" style="height:48px;"><input type="hidden" id="taskid${data.tasks.id}" name="taskid" value="${data.tasks.id}"><input type="checkbox" id="task${data.tasks.id}" onchange="checkerbox(event)" name="taskstatus" style="margin: 17.5px; width:15px; height:15px;" aria-label="Checkbox for following text input" value="True"><button type="submit" id="submitstatusbtn${data.tasks.id}" hidden></button></form></div><div class="col"><a class="nav-link active" href="#" role="button"><h5 class="maintaskname">`+data.tasks.task_h+`</h5></a></div><div class="col" style="max-width: max-content; padding:0%; "><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/more-vertical.svg' %}"></button></div><div class="col" style="max-width: max-content; padding:0%;"><form id="deletemain${data.main_id}" class="maintaskdelform"><input type="number" value="${data.main_id}" name="tasktodel" id="tasktodel${data.main_id}" hidden><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/trash-2.svg' %}"></button></form></div>`;
                    document.getElementById("mainc").append(newd);
                }
            }

            //for collapses
            function showdiv(sublinks){
                const divtoshow = document.querySelector(`#${sublinks}`)
                document.querySelectorAll('.sublink_div').forEach(sublink_div => {
                    sublink_div.style.display = "none"
                })
                
                if (divtoshow.style.display === "none"){
                    divtoshow.style.display = "block";
                } else {
                    divtoshow.style.display = "none";
                }
            }

            //for showing new tasks
            function dispmod(data, resp){
                const extdiv = document.createElement('div')
                extdiv.className = `row homedivs taskrow-${resp.task_id}`;
                extdiv.innerHTML = `<div class="col check-comp" style="padding: 0px ; max-width:50px;"><form id="status${resp.task_id}" class="completestatusform" style="height:48px;"><input type="hidden" id="taskid${resp.task_id}" name="taskid" value="${resp.task_id}"><input type="checkbox" id="task${resp.task_id}" onchange="checkerbox(event)" name="taskstatus" style="margin: 17.5px; width:15px; height:15px;" aria-label="Checkbox for following text input" value="True"><button type="submit" id="submitstatusbtn${resp.task_id}" hidden></button></form></div><div class="col"><a class="nav-link active" href="#" role="button"><h5 class="maintaskname">`+data.task_h.value+`</h5></a></div><div class="col" style="max-width: max-content; padding:0%; "><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/more-vertical.svg' %}"></button></div><div class="col" style="max-width: max-content; padding:0%;"><form id="deletemain${resp.id}" class="maintaskdelform"><input type="number" value="${resp.id}" name="tasktodel" id="tasktodel${resp.id}" hidden><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/trash-2.svg' %}"></button></div>`;
                document.getElementById("mainc").append(extdiv);

            }

            //for submitting new task form 
            function SubmitAddTask(form) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(form);

                XHR.addEventListener("load", function(event) {
                    const resp = XHR.response; // response from add event
                    dispmod(form, JSON.parse(resp));
                    document.getElementById("task_h").value = "";
                })

                XHR.addEventListener("error", function(event){
                    cosnole.log(event);
                })

                XHR.open("POST", "/add_task");
                XHR.send(formdata);
            }

            //Delete Main Task
            function DeleteTask(deletemaintaskform) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(deletemaintaskform);

                XHR.addEventListener("load", function(event) {
                    deletemaintaskform.parentElement.parentElement.remove();
                })

                XHR.addEventListener("error", function(event){
                    cosnole.log(event);
                })

                XHR.open("POST", `/del_task/${deletemaintaskform.tasktodel.value}`);
                XHR.send(formdata);
            }

            function CompleteTask(completetaskform) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(completetaskform);

                XHR.addEventListener("load", function(event) {
                    const pele = completetaskform.parentElement.parentElement;
                    const taskname = pele.getElementsByClassName("maintaskname")[0].innerHTML;
                    showcompletetask(taskname,completetaskform.taskid.value);
                    pele.style.display = "none";
                    
                })

                XHR.addEventListener("error", function(event){
                    console.log(event);
                })

                XHR.open("POST", `/complete/${completetaskform.taskid.value}`);
                XHR.send(formdata);
                
            }

            //main event linstener
            document.addEventListener('DOMContentLoaded', function () {

                //fetching data for existing tasks
                fetch('/tasks')
                .then(response => response.json())
                .then(data => {
                    data.forEach( data => {                                                                                                                           
                        disp(data);
                    })
                });

                //search bar
                const tasklist = document.querySelector("#mainc");
                const searchbar = document.forms["searchform"].querySelector('input');
                searchbar.addEventListener('keyup', function(event) {
                    const searchterm = event.target.value.toLowerCase();
                    const tasks = tasklist.getElementsByClassName("maintaskname");
                    Array.from(tasks).forEach(function(task){
                        const tname = task.textContent;
                        if(tname.toLowerCase().indexOf(searchterm) != -1){
                            task.parentElement.parentElement.parentElement.style.display = "flex";
                        }else{
                            task.parentElement.parentElement.parentElement.style.display = "none";
                        }
                    })
                })

                //For toggling
                document.querySelector('.inputform').style.display = "none";
                document.querySelectorAll('.sublink_div').forEach( sublink_div => {
                    sublink_div.style.display = "none";
                })

                document.querySelectorAll(".viewpage").forEach( viewpage => {
                    viewpage.addEventListener("click",  function(event) {
                        event.preventDefault();
                        console.log(viewpage);
                        if(viewpage.id === "pending"){
                            document.querySelectorAll(".homedivs").forEach( hidedivs => {
                                hidedivs.style.display = "none";
                            });
                            document.querySelector(`#${viewpage.dataset.target}`).style.display = "block";
                        }else if( viewpage.id === "home") {
                            const dtarget = viewpage.dataset.target
                            document.querySelector("#pendingtasks").style.display = "none";
                            document.querySelectorAll(`.${dtarget}`).forEach(dtarget => {
                                dtarget.style.display = "flex";
                            })
                        }
                    });
                });
                

                //For displaying add task form
                document.querySelector('#addbtn').onclick = () => {
                    const divs = document.querySelector('.inputform');
                    if(divs.style.display === "none"){
                            divs.style.display = "block";
                    }else {
                        divs.style.display = "none";
                    }
                };


                //for toggling sublinks of add task
                document.querySelectorAll('.sublink').forEach( sublink => {
                    sublink.onclick = function () {
                        showdiv(this.dataset.sublinks);
                    }
                });

                //for fetching add task form and deleting main task
                document.addEventListener("submit", function(event){
                    event.preventDefault();
                    const element = event.target;
                    if(element.id === "formaddtask"){
                        SubmitAddTask(element);   
                    }else if (element.className === "maintaskdelform"){
                        DeleteTask(element);
                    }else if (element.className === "completestatusform"){
                        CompleteTask(element);
                    }
                }); 
                
            });

        </script>
    </head>
    <body>
        <nav class="navbar navbar-dark bg-dark">
            <a class="navbar-brand mx-auto" href=#>TODO</a>  
        </nav>
        <div class="container-fluid">
            <ul class="nav">
                <div class="row ml-0 mr-0 w-100">
                    <div class="col">
                        <li class="nav-item float-left">
                            <a class="nav-link viewpage" href="#" id="pending" data-target="pendingtasks" role="button">Pending <span class="badge badge-primary badge-pill">3</span></a>
                          </li>
                    </div>
                    <div class="col">
                          <li class="nav-item float-left">
                            <a class="nav-link viewpage" href="#" id="home" id="home" data-target="homedivs" role="button">Home <img src="{% static 'main/home-outline.svg' %}" style="widows: 24px; height:24px;"></a>
                          </li>
                    </div>
                    <div class="col-4">
                        <li class="nav-item">
                            <form id="searchform">
                            <input type="text" id="searchinput" name="searchinput" class="form-control" placeholder="Search">
                            </form>
                        </li>
                    </div>
                    <div class="col">
                          <li class="nav-item float-right">
                            <a class="nav-link active" href="#">Breached <span class="badge badge-primary badge-pill">3</span></a>
                          </li>
                    </div>
                    <div class="col"><!--Analysis Bar-->
                        <li class="nav-item float-right">
                          <a class="nav-link" href="#">Analysis <img src="{% static 'main/activity.svg' %}"></a>
                        </li>
                  </div>
                </div>
            </ul>
            <div class="row">
                <div class="col-3"><!--Left Column for todays activity-->
                    <ul class="list-group">
                        <h5 class="text-center">Today</h3>
                        <a class="nav-link active" href="#">
                            <!--Use for loop here -->
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          Cras justo odio
                          <span class="badge badge-light">date</span>
                        </li>
                        </a>
                      </ul>
                </div>
                <div class="col-6" id="mainc"><!--Middle Column For Adding Task and Showing Task-->
                    <div class="row pendingtasks" id="pendingtasks"><!--For Addition information-->
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <h5 class="text-center">Pending Tasks</h5>
                                </div>
                                
                            </div>
                            <div class="row"> <!--Repeat This Col/ use for loop before this -->
                                
                            </div>
                        </div>
                    </div>
                    <div class="row homedivs"><!--For Adding Task-->
                        <div class="col">
                            <div class="row"><!--Add Button and Task name field-->
                                <div class="col" style="max-width:fit-content; padding:0%;">
                                    <button class="btn" type="button" id="addbtn">
                                        <img src="{% static 'main/add-24px.svg' %}">
                                    </button>
                                </div>
                                <div class="col float-right inputform" style="padding: 0px">
                                    <div class="row" style="width:inherit; margin:0%;">
                                        <div class="col" style="padding: 0px 5px;">
                                            <form id="formaddtask">
                                                <div class="form-group">
                                                <input type="text" name="task_h" class="form-control" id="task_h" placeholder="Task">
                                                </div>
                                                <div class="form-group" hidden>
                                                    <input type="text" name="task_d" class="form-control" id="task_d" placeholder="Task desc">
                                                </div>
                                                <input type="submit" id="tasksubmit" hidden>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="row"  style="width:inherit; margin:0%;"><!--Option Bar and Subtask add and many more option-->
                                        <div class="col" style="padding: 0px 5px"><!--Option Bar-->
                                            <ul class="nav nav-tabs form-option float-right" style="border-bottom: none;">
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="subtaskadd" role="button">Add Subtask</a>
                                                </li>
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="enddate" href="#enddate" role="button">End Date</a>
                                                </li>
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="reminder" href="#reminder" role="button">Reminder</a>
                                                </li>
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="notes" href="#notes" role="button">Notes</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row sublink_div" id="subtaskadd" style="width:inherit; margin:0%;"><!--Subtask add Bar-->
                                        <div class="col" style="padding: 0px 5px">
                                            <form>
                                                <div class="form-group">
                                                <input type="text" class="form-control" id="" placeholder="Sub Task">
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="max-height: 20px;"><!--Additional Row-->
                        <div class="col" style="max-height: 20px;">&nbsp</div>
                    </div>
                         <!--Do all show task here
                    <div class="row homedivs"> Repeat This Col/ use for loop before this
                    </div>-->
                </div>
                <div class="col-3"><!--Third column-->
                    <div class="row"><!--For Calender and date-->
                        <div class="col">
                            Input Current Date and calender Here
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">&nbsp</div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h5 class="text-center">Completed</h5>
                        </div>
                        <div class="col" style="max-width: max-content; padding:0%; ">
                            <button type="submit" class="btn" style="background-color: white; padding:3px 8px;">
                                <img src="{% static 'main/more-vertical.svg' %}">
                            </button>
                        </div>
                    </div>
                    <div class="row"><!--for completed tasks-->
                        <div class="col" id="completedtaskdiv">
                            <!--Repeat This section for Date and task completed on these dates-->
                            <div class="row">
                                <div class="col">
                                    For Date
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>