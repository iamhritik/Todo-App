<!DOCTYPE html>
{% load static %}
<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!--jquery-->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.bundle.min.js"></script>
        <!-- date picker-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datepicker/0.6.5/datepicker.min.css" integrity="sha256-b88RdwbRJEzRx95nCuuva+hO5ExvXXnpX+78h8DjyOE=" crossorigin="anonymous" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/datepicker/0.6.5/datepicker.min.js" integrity="sha256-/7FLTdzP6CfC1VBAj/rsp3Rinuuu9leMRGd354hvk0k=" crossorigin="anonymous"></script>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet"> 
        <style>
            body {
                color:#007bff;            
            }
            .form-control {
                border: none;
            }
            .form-option .btn {
                border-radius: 0%;
                border: none;
            }
            .navbar-collapse {
                flex-basis: 0%;
            }
            .inputform {
                display: block;
            }
            .sublink_div {
                display: none;
            }
            #pendingtasks {
                display: none;
            }
            .clockdate-wrapper {
                background-color: #007bff;
                padding:5px;
                max-width:250px;
                width:100%;
                text-align:center;
                border-radius:5px;
                margin:0 auto;
                margin-top:5%;
            }
            #clock{
                background-color:#007bff;
                font-size:15px;
                text-shadow:0px 0px 1px #fff;
                color:#fff;
            }
            #clock span {
                color: #fff;
                text-shadow:0px 0px 1px #333;
                font-size:9px;
                position:relative;
                top:-7px;
                left:-1px;
            }
            #date {
                letter-spacing:2px;
                font-size:10px;
                color:#fff;
            }
            .sublink{
                font-family: 'Roboto', sans-serif!important;
                font-size:0.9em!important;
            }

        </style>
        <script>
            //this function is for csrf token
            function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            function Load_Task_Data()
            {
                var a = "{{sample_task_owner}}";
                console.log(a)
                fetch(`/task-list/${a}`,{
                method:'GET',
                headers:{
                    'Content-type':'application/json', 
                    'X-CSRFToken':csrftoken,
                },
            })
                .then(resp => resp.json())
                .then(data => {
                    data.forEach( subd => {
                        disp(subd);
                        TodayTasks(subd);
                        Breached_Tasks();
                    });
                })
            }


            var id;
            //clock and date
            function startTime() {
                var today = new Date();
                var hr = today.getHours();
                var min = today.getMinutes();
                var sec = today.getSeconds();
                ap = (hr < 12) ? "<span>AM</span>" : "<span>PM</span>";
                hr = (hr == 0) ? 12 : hr;
                hr = (hr > 12) ? hr - 12 : hr;
                //Add a zero in front of numbers<10
                hr = checkTime(hr);
                min = checkTime(min);
                sec = checkTime(sec);
                document.getElementById("clock").innerHTML = hr + ":" + min + ":" + sec + " " + ap;
                
                var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                var curWeekDay = days[today.getDay()];
                var curDay = today.getDate();
                var curMonth = months[today.getMonth()];
                var curYear = today.getFullYear();
                var date = curWeekDay+", "+curDay+" "+curMonth+" "+curYear;
                document.getElementById("date").innerHTML = date;
                
                var time = setTimeout(function(){ startTime() }, 500);
            }

            function checkTime(i) {
                if (i < 10) {
                    i = "0" + i;
                }
                return i;
            }

            //To submit after checking task
            function checkerbox(event){
                const targform = event.target.parentElement; 
                targform[3].click();
            }

            function showcompletetask(name, taskid){
                const comd = document.createElement('div');
                comd.className = `row completetaskrow-${taskid}`;
                comd.innerHTML = `<div class="col"><a class="nav-link active" href="#" role="button"><h6 style="text-decoration: line-through;">${name}</h6></a></div><div class="col" style="max-width: max-content; padding:0%;"><form id="compldeletemain${taskid}" class="maintaskdelform">{%csrf_token%}<input type="number" value="${taskid}" name="tasktodel" hidden><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/trash-2.svg' %}" style="width:20px; height:20px;"></button></div>`;
                document.getElementById("completedtaskdiv").append(comd);
            }

            //display already existing tasks
            function disp(data){
                if(data.complete === true){
                    showcompletetask(data.task_h,data.id);
                }else {
                    const new_div = document.createElement('div');
                    new_div.className = `row homedivs tasks taskrow-${data.id}`;
                    new_div.innerHTML = `<div class="col check-comp" style="padding: 0px ; max-width:40px;"><form id="status${data.id}" class="completestatusform" style="height:48px;">{%csrf_token%}<input type="hidden" id="taskid${data.id}" name="taskid" value="${data.id}"><input type="checkbox" id="task${data.id}" onchange="checkerbox(event)" name="taskstatus" style="margin: 17.5px; width:15px; height:15px;" aria-label="Checkbox for following text input" value="True"><button type="submit" id="submitstatusbtn${data.id}" hidden></button></form></div><div class="col"><a class="nav-link active" href="#" role="button"><div class="row"><div class="col"><h5 class="maintaskname">`+data.task_h+`</h5></div><div class="col"><span style="display:none;">${data.added_date}</span><span style="float:right; max-width:fit-content; color:#a31e17;">${data.end_date===null?"No End Date":data.end_date.slice(0,10)}</span></div></div></a></div><div class="col" style="max-width: max-content; padding:0%; "><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/more-vertical.svg' %}"></button></div><div class="col" style="max-width: max-content; padding:0%;"><form id="deletemain${data.id}" class="maintaskdelform">{%csrf_token%}<input type="number" value="${data.id}" name="tasktodel" id="tasktodel${data.id}" hidden><button type="submit" class="btn" style="background-color: white;"><img src="{% static 'main/trash-2.svg' %}"></button></form></div>`;
                    document.getElementById("mainc").append(new_div);
                }
            }

            //for collapses:great work kachde
            function showdiv(sublinks){
                const divtoshow = document.querySelector(`#${sublinks}`)
                document.querySelectorAll('.sublink_div').forEach(sublink_div => {
                    sublink_div.style.display = "none"
                })
                
                if (divtoshow.style.display === "none"){
                    divtoshow.style.display = "block";
                } else {
                    divtoshow.style.display = "none";
                }
            }

            //show pending tasks
            function Pending_Tasks(){
                const container_div = document.getElementById('pending_container');
                const all_tasks_div = document.getElementsByClassName('tasks');
                for(var ele of all_tasks_div)
                {            
                    var spans = ele.getElementsByTagName('span');
                    if(spans[1].innerHTML != 'No End Date'){
                        var ele_date = (spans[1].innerHTML).slice(0,10);
                        var current_date = new Date();
                        //console.log("current date is:"+current_date)
                        //console.log("ele_data is :" +ele_date)
                        if((current_date.getFullYear() > ele_date.slice(0,4)) || (current_date.getFullYear() == ele_date.slice(0,4) && (current_date.getMonth()+1) > ele_date.slice(5,7)) || (current_date.getFullYear() == ele_date.slice(0,4) && (current_date.getMonth()+1) == ele_date.slice(5,7) && current_date.getDate() > ele_date.slice(8,10)) )
                        {
                            ele.style.display = "flex";
                        }
                    }
                }
                
            }

            //Show tasks needed to be done by today
            function TodayTasks(ele)
            {
                const cdate = new Date();
                
                if(ele.end_date != null && ele.end_date.slice(0,4) == cdate.getFullYear() && ele.end_date.slice(5,7)-1 == cdate.getMonth() && ele.end_date.slice(8,10) == cdate.getDate())
                {
                    console.log('I m in');
                    const today_tasks = document.createElement('div');
                    today_tasks.innerHTML = `<a class="nav-link active" href="#"><li class="list-group-item d-flex justify-content-between align-items-center">${ele.task_h}<span class="badge badge-light">${ele.complete==true?'Completed':'Pending'}</span></li></a>`;
                    document.getElementById('left_side_container').append(today_tasks);        
                }
            }

            function checkboxer(){
                if (document.getElementById("taskupp").checked == false) 
                    {
                        console.log("not checked");
                    } else {    
                        document.getElementById("submitstatusbtn").click();
                        console.log("checked");
                    }
            }

            //for submitting new task form 
            function SubmitAddTask(form) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(form);

                XHR.addEventListener("load", function(event) {
                    const resp = JSON.parse(XHR.response);
                    console.log(resp)
                    // response from add event
                    disp(resp);
                    TodayTasks(resp);
                    document.getElementById("task_h").value = "";
                    document.getElementById("end_date").value= "";
                })

                XHR.addEventListener("error", function(event){
                    console.log(event);
                })

                XHR.open("POST", "/task-add/");
                XHR.send(formdata);
            }


            //Delete Main Task
            function DeleteTask(deletemaintaskform) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(deletemaintaskform);

                XHR.addEventListener("load", function(event) {
                    deletemaintaskform.parentElement.parentElement.remove();
                    console.log(event);

                })

                XHR.addEventListener("error", function(event){
                    console.log(event);
                })

                XHR.open("POST", `/del_task/${deletemaintaskform.tasktodel.value}`);//using task id their
                XHR.send(formdata);
            }

            function CompleteTask(completetaskform) {
                const XHR = new XMLHttpRequest();
                const formdata = new FormData(completetaskform);
                XHR.addEventListener("load", function(event) {
                    const pele = completetaskform.parentElement.parentElement;
                    console.log(pele)
                    const taskname = pele.getElementsByClassName("maintaskname")[0].innerHTML;
                    showcompletetask(taskname,completetaskform.taskid.value);
                    pele.remove();
                    
                })

                XHR.addEventListener("error", function(event){
                    console.log(event);
                })

                XHR.open("POST", `/complete/${completetaskform.taskid.value}`);
                XHR.send(formdata);
                
                
            }

            //for analysis chart 
            function setchart(labels,defaultdata){
                var ctx = document.getElementById('myChart');
                var myChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels:labels,
                        datasets: [{
                        label: '',
                        data: defaultdata,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(48,124,255, 0.3)',
                                'rgba(60,179,113, 0.2)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(60,179,113, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }
            //count breahced tasks
            function Breached_Tasks(){
                var breach = 0;
                const container_div = document.getElementById('pending_container');
                const all_tasks_div = document.getElementsByClassName('tasks');
                for(var ele of all_tasks_div)
                {            
                    var spans = ele.getElementsByTagName('span');
                    if(spans[1].innerHTML != 'No End Date'){
                        var ele_date = (spans[1].innerHTML).slice(0,10);
                        var current_date = new Date();
                        //console.log("current date is:"+current_date)
                        //console.log("ele_data is :" +ele_date)
                        if((current_date.getFullYear() > ele_date.slice(0,4)) || (current_date.getFullYear() == ele_date.slice(0,4) && (current_date.getMonth()+1) > ele_date.slice(5,7)) || (current_date.getFullYear() == ele_date.slice(0,4) && (current_date.getMonth()+1) == ele_date.slice(5,7) && current_date.getDate() > ele_date.slice(8,10)) )
                        {
                            breach++
                            console.log(breach)
                        }
                    }
                }
                return breach;
            }

            //main event linstener
            document.addEventListener('DOMContentLoaded', function () {

                startTime();
                Load_Task_Data();

                //search bar
                const tasklist = document.querySelector("#mainc");
                const searchbar = document.forms["searchform"].querySelector('input');
                searchbar.addEventListener('keyup', function(event) {
                    const searchterm = event.target.value.toLowerCase();
                    const tasks = tasklist.getElementsByClassName("maintaskname");
                    Array.from(tasks).forEach(function(task){
                        const tname = task.textContent;
                        if(tname.toLowerCase().indexOf(searchterm) != -1){
                            task.parentElement.parentElement.parentElement.parentElement.parentElement.style.display = "flex";
                        }else{
                            task.parentElement.parentElement.parentElement.parentElement.parentElement.style.display = "none";
                        }
                    })
                })

                //For toggling
                document.querySelector('.inputform').style.display = "none";
                document.querySelectorAll('.sublink_div').forEach( sublink_div => {
                    sublink_div.style.display = "none";
                })

                document.querySelectorAll(".viewpage").forEach( viewpage => {
                    viewpage.addEventListener("click",  function(event) {
                        event.preventDefault();
        
                        if(viewpage.id === "pending"){
                            document.querySelectorAll(".homedivs").forEach( hidedivs => {
                                hidedivs.style.display = "none";
                            });
                            document.querySelector(".chartmain").style.display = "none";
                            document.querySelector(`#${viewpage.dataset.target}`).style.display = "block";
                            Pending_Tasks();
                        }else if( viewpage.id === "home") {
                            const dtarget = viewpage.dataset.target
                            document.querySelector("#pendingtasks").style.display = "none";
                            document.querySelector(".chartmain").style.display = "none";
                            document.querySelectorAll(`.${dtarget}`).forEach(dtarget => {
                                dtarget.style.display = "flex";
                            })
                        }
                        else if( viewpage.id === "analysis") {
                            document.querySelectorAll(".homedivs").forEach( hidedivs => {
                                hidedivs.style.display = "none";});
                            document.querySelector("#pendingtasks").style.display = "none";
                            document.querySelectorAll('.pendingtasks').forEach(dtarget => {
                                dtarget.style.display = "none";
                            })

                            console.log(viewpage.dataset.target)
                            var chartelement=document.querySelector(".chartmain")
                            chartelement.style.display = "block";
                            chartelement.style.cssText = "width:500px;height:200px;margin-top:3em;padding-left:7em;"
                            var endoint = '/chartdata/'
                            var defaultdata = []
                            var labels = []
                            breach_count = Breached_Tasks()
                            fetch('/chartdata/',{
                                method:'GET',
                                headers:{
                                'Content-type':'application/json',                 
                                }
                            })
                            .then(resp => resp.json())
                            .then(data => {
                                labels = data.labels
                                defaultdata = data.default
                                defaultdata.unshift(breach_count)
                                setchart(labels,defaultdata) 

                            })
                        }

                    });
                });
                

                document.querySelector('#mega-submit').addEventListener("click", event => {
                    const form1 = document.querySelector('#formaddtask');
                    form1.children[1].children[0].children[0].children[0].children[1].click();
                });

                //For displaying add task form
                document.querySelector('#addbtn').onclick = () => {
                    const divs = document.querySelector('.inputform');
                    if(divs.style.display === "none"){
                            divs.style.display = "block";
                    }else {
                        divs.style.display = "none";
                    }
                };


                //for toggling sublinks of add task
                document.querySelectorAll('.sublink').forEach( sublink => {
                    sublink.onclick = function () {
                        showdiv(this.dataset.sublinks);
                    }
                });

                //for fetching add task form and deleting main task :correct this one kachde
                document.addEventListener("submit", function(event){
                    event.preventDefault();
                    const element = event.target;
                    if(element.id === "formaddtask"){
                        SubmitAddTask(element);   
                    }else if (element.className === "maintaskdelform"){
                        DeleteTask(element);
                    }else if (element.className === "completestatusform"){
                        CompleteTask(element);
                    }
                }); 
                
            });

        </script>
    </head>
    <body>
        <nav class="navbar navbar-dark" style="background-color: #007bff;">
            <a class="navbar-brand mx-auto" href=#>TODO</a>  
        </nav>
        <div class="container-fluid">
            <ul class="nav" style="font-family: 'Poppins', sans-serif;">
                <div class="row ml-0 mr-0 w-100">
                    <div class="col">
                        <li class="nav-item float-left">
                            <a class="nav-link viewpage" href="#" id="pending" data-target="pendingtasks" role="button">Breached <span class="badge badge-primary badge-pill"></span></a>
                          </li>
                    </div>
                    <div class="col">
                          <li class="nav-item float-left">
                            <a class="nav-link viewpage" href="#" id="home" id="home" data-target="homedivs" role="button">Home <img src="{% static 'main/home-outline.svg' %}" style="width: 20px; height:20px;"></a>
                          </li>
                    </div>
                    <div class="col-4">
                        <li class="nav-item">
                            <form id="searchform">
                            <input type="text" id="searchinput" name="searchinput" class="form-control" placeholder="Search">
                            </form>
                        </li>
                    </div>
                    <div class="col"><!--Analysis Bar-->
                        <li class="nav-item float-right">
                          <a class="nav-link viewpage" href="#" id="analysis" data-target="pendingtasks" role="button">Analysis <img src="{% static 'main/activity.svg' %}" style="width:15px;height:15px;"></a>
                        </li>
                    </div>
                    <div class="col"><!--Logout button-->
                        <li class="nav-item float-right">
                            <a class="nav-link" href="/accounts/logout" id="logout">Logout</a>
                        </li>
                    </div>
                </div>
            </ul>
            <div class="row">
                <div class="col-3"><!--Left Column for todays activity-->
                    <ul class="list-group" id="left_side_container">
                        <h5 class="text-center">Today</h3>
                        
                    </ul>
                </div>
                <div class="col-6" id="mainc"><!--Middle Column For Adding Task and Showing Task-->
                    <div class="row pendingtasks" id="pendingtasks"><!--For Addition information-->
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <h5 class="text-center">Tasks Exceeded End Date</h5>
                                </div>
                            </div>
                            <div class="row" id="pending_container"> <!--Repeat This Col/ use for loop before this -->
                                
                            </div>
                        </div>
                    </div>
                    <div class="chartmain">
                        <canvas id="myChart" style="width:10px;height:10px;"></canvas>
                    </div>
                    <div class="row homedivs"><!--For Adding Task-->
                        <div class="col">
                            <div class="row"><!--Add Button and Task name field-->
                                <div class="col" style="max-width:fit-content; padding:0%;">
                                    <button class="btn" type="button" id="addbtn">
                                        <img src="{% static 'main/add-24px.svg' %}">
                                    </button>
                                </div>
                                <div class="col float-right inputform" style="padding: 0px">
                                    <form id="formaddtask">
                                    {% csrf_token %}
                                    <div class="row" style="width:inherit; margin:0%;">
                                        <div class="col" style="padding: 0px 5px;">
                                            <div class="row">
                                            <div class="col-10">
                                                <div class="form-group">
                                                <input type="text" name="task_h" class="form-control" id="task_h" placeholder="Task">
                                                </div>
                                                <input type="submit" id="tasksubmit" hidden>
                                            </div>
                                            <div class="col-2">
                                                <button type="button" id="mega-submit" style="text-align:center; border:none; width:50px; height:40px;">Add</button>
                                            </div></div>
                                        </div>
                                    </div>
                                    <div class="row"  style="width:inherit; margin:0%;"><!--Option Bar and Subtask add and many more option-->
                                        <div class="col" style="padding: 0px 5px"><!--Option Bar-->
                                            <ul class="nav nav-tabs form-option float-right" style="border-bottom: none;">
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="datepick" role="button">End Date</a>
                                                </li>
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="reminder" href="#reminder" role="button">Reminder</a>
                                                </li>
                                                <li class="nav-item" style="height: 26px;">
                                                    <a class="nav-link active  sublink" style="border: none; padding: 1px 8px; font-size:small;" data-sublinks="notes" href="#notes" role="button">Notes</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row sublink_div" id="datepick" style="width:inherit; margin:0%;"><!--end date add Bar-->
                                        <div class="col" style="padding: 0px 5px">
                                                <div class="form-group">
                                                <input type="date" class="form-control" name="end_date" id="end_date" placeholder="date">
                                                <script>
                                                    $(function () {
                                                      $("#id_date").datepicker({
                                                        format:'dd/mm/yyyy',
                                                      });
                                                    });
                                                </script>
                                                </div>
                                        </div>
                                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="max-height: 20px;"><!--Additional Row-->
                        <div class="col" style="max-height: 20px;">&nbsp</div>
                    </div>
                         <!--Do all show task here
                    <div class="row homedivs"> Repeat This Col/ use for loop before this
                    </div>-->
                </div>
                <div class="col-3"><!--Third column-->
                    <div class="row"><!--For Calender and date-->
                        <div class="col">
                            <div id="clockdate">
                                <div class="clockdate-wrapper">
                                  <div id="clock"></div>
                                  <div id="date"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">&nbsp</div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h5 class="text-center">Completed</h5>
                        </div>
                        <div class="col" style="max-width: max-content; padding:0%; ">
                            <button type="submit" class="btn" style="background-color: white; padding:3px 8px;">
                                <img src="{% static 'main/more-vertical.svg' %}">
                            </button>
                        </div>
                    </div>
                    <div class="row"><!--for completed tasks-->
                        <div class="col" id="completedtaskdiv">
                            <!--Repeat This section for Date and task completed on these dates-->
                            <div class="row">
                                <div class="col">
                                    For Date
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <canvas id="myChart" style="width:100px!important;height:100px!important;"></canvas>
    </body>
</html>